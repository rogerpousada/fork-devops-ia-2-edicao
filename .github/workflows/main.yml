name: CI-CD
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
jobs:
    CI:
        runs-on: ubuntu-latest
        env:
            SKIP_BUILD: 'true'
        steps:
            - name: Checkout
              uses: actions/checkout@v5
              
            - uses: actions/setup-python@v6
              with:
                python-version: '3.11' 
                
            - name: Install Dependencies
              working-directory: 02-encontros-tech
              run: |
                python -m pip install --upgrade pip 
                pip install -r requirements.txt
            
            - name: Testes
              working-directory: 02-encontros-tech
              run: python -m pytest tests/ -v  
            
            # Docker build/push steps intentionally removed â€” SKIP_BUILD behavior: build is disabled by default.

    CD-homolog:
        runs-on: ubuntu-latest
        environment: homolog
        needs: [CI]
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Kubernetes Set Context
              uses: azure/k8s-set-context@v4
              with:
                method: kubeconfig
                kubeconfig: ${{ secrets.KUBECONFIG }}

            - name: Create namespace if not exists
              run: kubectl create namespace tech-homolog --dry-run=client -o yaml | kubectl apply -f -
                
            - name: Create secrets in homolog
              run: |
                kubectl create secret generic encontros-tech-secrets \
                  --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                  --namespace=tech-homolog \
                  --dry-run=client -o yaml | kubectl apply -f -                

            - name: Deploy to Kubernetes Cluster
              uses: azure/k8s-deploy@v5
              with:
                namespace: tech-homolog
                manifests: |
                  name: legacy-main (DEPRECATED)

                  on:
                    workflow_dispatch:

                  jobs:
                    noop:
                      runs-on: ubuntu-latest
                      name: noop
                      steps:
                        - name: noop
                          run: |
                            echo "This workflow has been deprecated. Use .github/workflows/ci-cd.yml instead."
              with:
