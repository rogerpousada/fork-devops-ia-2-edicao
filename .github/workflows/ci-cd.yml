name: CI/CD — Build and Deploy

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:

env:
  IMAGE_NAME: encontros-tech
  DEFAULT_IMAGE: python:3.11-slim
  SKIP_BUILD: 'true'

jobs:
  build:
    name: Build and push image
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Check DO token
        id: docheck
        run: |
          if [ -n "${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}" ]; then
            echo "DO_TOKEN_PRESENT=true" >> $GITHUB_OUTPUT
          else
            echo "DO_TOKEN_PRESENT=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate doctl
        if: ${{ env.SKIP_BUILD != 'true' && steps.docheck.outputs.DO_TOKEN_PRESENT == 'true' }}
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        if: ${{ env.SKIP_BUILD != 'true' && steps.docheck.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: doctl registry login

      - name: Build and push image to DOCR
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./02-encontros-tech
          push: true
          tags: registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64,linux/arm64

      - name: Set image output
        id: set-image
        run: |
          # If build was skipped, fall back to DEFAULT_IMAGE; otherwise use the DOCR tag
          if [ "${SKIP_BUILD}" = "true" ]; then
            echo "image=${DEFAULT_IMAGE}" >> $GITHUB_OUTPUT
          else
            echo "image=registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  deploy-staging:
    name: Deploy to Staging (homologação)
    needs: build
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check DO token (deploy)
        id: docheck_deploy_staging
        run: |
          if [ -n "${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}" ]; then
            echo "DO_TOKEN_PRESENT=true" >> $GITHUB_OUTPUT
          else
            echo "DO_TOKEN_PRESENT=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate doctl
        if: ${{ steps.docheck_deploy_staging.outputs.DO_TOKEN_PRESENT == 'true' }}
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig for staging cluster
        if: ${{ steps.docheck_deploy_staging.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: |
          doctl kubernetes cluster kubeconfig save "${{ secrets.STAGING_CLUSTER_NAME }}"

      - name: Render manifests with image
        run: |
          # Install envsubst (gettext)
          sudo apt-get update -y && sudo apt-get install -y gettext-base
          # Prefer image from build output; fallback to DEFAULT_IMAGE
          IMAGE="${{ needs.build.outputs.image }}"
          if [ -z "${IMAGE}" ]; then IMAGE="${{ env.DEFAULT_IMAGE }}"; fi
          echo "Using image: ${IMAGE}"
          export IMAGE
          envsubst < 02-encontros-tech/k8s/manifests.yaml > /tmp/encontros-tech-rendered.yaml

      - name: Create/update DB secret (staging)
        if: ${{ steps.docheck_deploy_staging.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: |
          kubectl create secret generic encontros-tech-secrets \
            --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL_STAGING }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply manifests to staging
        run: |
          kubectl apply -f /tmp/encontros-tech-rendered.yaml

  deploy-production:
    name: Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check DO token (deploy)
        id: docheck_deploy_prod
        run: |
          if [ -n "${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}" ]; then
            echo "DO_TOKEN_PRESENT=true" >> $GITHUB_OUTPUT
          else
            echo "DO_TOKEN_PRESENT=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate doctl
        if: ${{ steps.docheck_deploy_prod.outputs.DO_TOKEN_PRESENT == 'true' }}
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig for production cluster
        if: ${{ steps.docheck_deploy_prod.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: |
          doctl kubernetes cluster kubeconfig save "${{ secrets.PRODUCTION_CLUSTER_NAME }}"

      - name: Render manifests with image
        run: |
          sudo apt-get update -y && sudo apt-get install -y gettext-base
          IMAGE="${{ needs.build.outputs.image }}"
          if [ -z "${IMAGE}" ]; then IMAGE="${{ env.DEFAULT_IMAGE }}"; fi
          echo "Using image: ${IMAGE}"
          export IMAGE
          envsubst < 02-encontros-tech/k8s/manifests.yaml > /tmp/encontros-tech-rendered.yaml

      - name: Create/update DB secret (production)
        if: ${{ steps.docheck_deploy_prod.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: |
          kubectl create secret generic encontros-tech-secrets \
            --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL_PRODUCTION }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply manifests to production
        if: ${{ steps.docheck_deploy_prod.outputs.DO_TOKEN_PRESENT == 'true' }}
        run: |
          kubectl apply -f /tmp/encontros-tech-rendered.yaml
